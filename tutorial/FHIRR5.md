# Converting vanilla JSON to FHIR RDF
See: https://github.com/fhircat/FHIRCat/issues/2 for additional information


This document describes the additional "tweaks" that are needed beyond the standard JSON-LD 1.1 context extensions that
are needed to transform "vanilla" FHIR JSON into FHIR RDF.  

The goals of this project include:
1) To document the (a) minimal set of changes that would be required to generate the RDF found in the 
[HL7 FHIR ITS specification](http://build.fhir.org/rdf.html) as it exists today.
2) To provide a foundation on which can be used to prototype, test, and evaluate proposed simplifications to the existing
specification.

## Nomenclature
* **Vanilla JSON (or just "JSON" when the context is obvious)** - FHIR JSON representations in use in the FHIR ecosystem today.
* **R4 JSON** - FHIR JSON that has been modified to include additional elements, such as the `fhir:nodeRole` item,
explicit list ordering, extensible values, etc.


## JSON LD 1.1 Contexts
There are currently two JSON-LD 1.1 context repositories that can be used in the development below, these being:
* https://github.com/fhircat/jsonld_context_files - these files were generated by an extension to the core FHIR build
package and, assuming that this project is successful, will become part of the core FHIR distribution.
* https://github.com/fhircat/fhir_to_jsonld_context -- this is a early converter that takes the JSON representation
of the FHIR ShEx as input and generates the same set of files.  _It is anticipated that this branch will eventually be
retired._

There is also a FHIR context server at https://fhircat.org/fhir/contexts/r5/ that, at the moment, serves an image of the ShEx conversion above.  
As an example, one can fetch the JSON-LD context for the [FHIR Patient resource](http://build.fhir.org/patient.html)
via https://fhircat.org/fhir/contexts/r5/patient.context/jsonld

_Warning:_ These contexts are still in the early stages of development.  These contexts will be in a state of flux for
at least a while yet.


## Transformations

### RDF Namespace Prefixes

   The list below carries  current set of RDF namespaces that are used by at least one FHIR resource.  
   
   ```  
   @context: {
       "fhir": "http://hl7.org/fhir/",
       "owl": "http://www.w3.org/2002/07/owl#",
       "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
       "rdfs": "http://www.w3.org/2000/01/rdf-schema#",
       "xsd": "http://www.w3.org/2001/XMLSchema#",
       "dc": "http://purl.org/dc/elements/1.1/",
       "cs": "http://hl7.org/orim/codesystem/",
       "dc": "http://purl.org/dc/elements/1.1/",
       "dcterms": "http://purl.org/dc/terms/",
       "dt": "http://hl7.org/orim/datatype/",
       "ex": "http://hl7.org/fhir/StructureDefinition/",
       "fhir-vs": "http://hl7.org/fhir/ValueSet/",
       "loinc": "http://loinc.org/rdf#",
       "os": "http://open-services.net/ns/core#",
       "rim": "http://hl7.org/orim/class/",
       "rim": "http://hl7.org/owl/rim/",
       "sct": "http://snomed.info/id/",
       "vs": "http://hl7.org/orim/valueset/",
       "w5": "http://hl7.org/fhir/w5#"
   }
   ```
    
   **TODO:** This list will continue to expand as new code systems and other things are added to FHIR.  We need to
    develop a mechanism ([prefixcommons](https://github.com/prefixcommons)?, CTS2 service?) to maintain them.  For the
    time being, we've added them to our [current context directory](https://github.com/fhircat/jsonld_context_files/tree/master/contextFiles/root.context.jsonld)
    
### The Resource Subject
We need to insert an `@id` into the root JSON object to assign the subject URI of the resource.  The subject URI is
constructed from three components:

1) The resource `id` (e.g. 'pat4')
2) The resource type ('resourceType') (e.g. 'Patient')
3) The server base address - see: http://build.fhir.org/resource.html#id for details.

Note that the `resourceType` must also be edited to assume the "value" form.  This transformation is described in more
detail later in this document.

**JSON:** 
```
  "resourceType": "Patient",
  "id": "pat4",
```

**R4 JSON:**

Add the "@id" node as a combination of the Resource type and the `id`
```
   "resourceType" : {"value": "Patient"},
   "id": {"value": "pat4"},
   "@id": "Patient/pat4",
```

**JSON-LD Context:**

(Optional) add a base, which will be used to interpret all target idenfiers.

Notes:
1) If there is no base, this defaults to the location of the "document", which can often be a bit unexpected...
2) `@base` is ignored if it is part of a context fetched as a URL.  It _must_ be an element of the JSON document itself.

```text
  "@context": [{
     ... 
  }, 
  {
    "@base": "http://build.fhir.org/"
  }
```


**[Example](http://tinyurl.com/u7j8aco)**
   
### The Resource Type
The RDF equivalent of the FHIR JSON `"resourceType"` is `rdf:type`.  The snippet:

**JSON-LD Context:**
```
     "resourceType": {
      "@id": "rdf:type",
      "@type": "@id"
    },
```

is a part of every FHIR JSON-LD Resource Context (e.g. [patient.context.jsonld](https://raw.githubusercontent.com/fhircat/jsonld_context_files/master/contextFiles/patient.context.jsonld)
The only bit to take note of is that the `resourceType` should not be transformed to to an embedded value.
 
**[Example](http://tinyurl.com/u7j8aco)**
    
### Tree Root
JSON notation represents a rooted tree. RDF, on the other hand, can represent any graph, meaning that it is necessary
to identify the subject that represents the root of the JSON tree.  We do this by adding the `fhir:nodeRole` element
to the subject of a FHIR resource

**R4 JSON:**
Add the following line to the root document
```
   "fhir:nodeRole" : "fhir:treeRoot",
```

   
**[Example](http://tinyurl.com/u7j8aco)**

### Primitive Values
    
With the exceptions  below, all FHIR primitive types have to be converted to a JSON object with a `"value` 
element.

1) elements that begin with '@' (json-ld instructions)
2) objects and lists -- although they do have to be processed recursively
3) `"id"` elements -- these become the subjects of their container
4) '"resourceType", "nodeRole", "index", "div"' elements -- the first three of these have been added and the `"div"`
element turns out to be an exception to the FHIR extensibility rule.
    
**JSON:**
    
```
   "(key)": "(val)"
```

**R4 JSON:**
```
   "(key)" : {"value": "(val)"},

```
See:  
    
6) **list ordering**
 
    JSON lists are ordered.  JSON-LD lists are not, so it is necessary to add an ordering index to list elements.
   
    _**Question**_: Is it possible to have a list within a list in FHIR (e.g. `"foo": [["bar": 17, ...], ...])`?
    
    For each _object_ within a list, add a relative index:
    
    R4 JSON
    ```json
    {
        "telecom": [
        {
          "index": 0,
          "use": "home"
        },
        {
           "index": 1,
          "system": "phone",
          "value": "(03) 5555 6473",
          "use": "work",
          "rank": 1
        },
        {
           "index": 2,
          "system": "phone",
          "value": "(03) 3410 5613",
          "use": "mobile",
          "rank": 2
        },
        {
          "index": 3,
          "system": "phone",
          "value": "(03) 5555 8834",
          "use": "old",
          "period": {
            "end": "2014"
          }
        }
      ]
   }
   ```
   
   Note that lists may be (indirectly) nested within other lists

6) **References**
    FHIR references require two additions:
   
   1) The [Reference](http://build.fhir.org/references.html#Reference) data type includes the `reference` attribute, a "Literal reference, Relative, 
   internal or absolute URL".  If this is a relative reference, it is relative to the _parent_ of the resource, not the
   resource itself.  As an example, if the resource at the URL `https://fhirserver.org/Observation/o12345` contains a reference
   to `"Patient/P1111`, the full URI reference would be `"https://fhirserver.org/Patient/P1111"` instead of 
   `"https://fhirserver.org/Observation/Patient/P1111"`, which is what you would get with a normal web page.  As a 
   consequence, ".." needs to be prepended to any _relative_ `Reference.reference` entry.  Example:
   
   ```json
     "subject": {
       "reference": "Patient/f001",
       "display": "P. van de Heuvel"
      }
    ``` 
   Becomes:
   ```json
     "subject": {
       "fhir:link": {"@id": "../Patient/f001"},
       "reference": "Patient/f001",
       "display": "P. van de Heuvel"
      }
    ``` 
   
   The R4 specification also adds a "type arc", in the form:
   ```text
   <http://hl7.org/fhir/Patient/f001> a fhir:Patient .
   ```
   If the type of the reference can be determined.  Since the R4 RDF specification was published, a new (albeit optional)
   field was added to the `Reference` type, `type`, which (while specified as a URI?) identifies the FHIR data type.  To
   completely match the R4 specification, and _if_ there is a `reference` attribute the pre-processor needs to insert 
   the `link` arc:
    ```json
    "subject": {
       "reference": "Patient/f001",
       "display": "P. van de Heuvel",
       "link": {
          "@id": "../Patient/f001",
          "@type": "Patient"
       }   
    }
    ``` 
   where the `"@id"` is the `reference` with a '..' prepended if it is relative, and the type is the `"type"` field if
   it is present and, if not, if the URL matches the recommended FHIR Regexp (to be supplied), the resource type from
   there, otherwise, omit it.

        
3) **RDF data types**

    All non-string values need to have a corresponding RDF datatype inserted.  This requires access to the 
    FHIR metamodel, as the JSON itself does not have sufficient typing information.
    
    1) **Case 1:** value has an explicit type - see: http://build.fhir.org/datatypes.html#Period for an example, where both
       the start and end nodes are of the _FHIR_ type `dateTime`. The current R4 type map can be found in 
       [RDFTypeMap.java](https://github.com/HL7/fhir/blob/master/implementations/java/org.hl7.fhir.rdf/src/org/hl7/fhir/rdf/RDFTypeMap.java).
       
    2) **Case 2:** variable value type - the datatype is encoded onto the end of the variable name.  This can be identified
       in the FHIR metamodel, and is represented as `<tag>[x]` where `x` is the actual datatype (e.g. `valueBoolean`, 
       `valueDateTime`, etc.) The data type has to be parsed from the key and then mapped as with Case 1 above.
       
4) **ID and extension transformation for primitive types**
    
    FHIR primitive types derive from [Element](http://build.fhir.org/types.html#Element), meaning that _any_ data element
    can have an `id` and/or `extension`.  The FHIR JSON rendering keeps underlying data "primitive" (i.e. represented as
    a value, not a JSON Object), but uses a lexical convention to associate the base element with the additional attributes.
    The JSON will prepend an underscore ('_') to the key name with an object that contains the `id` and/or `extension`.
    
    Whenever you encounter a tag with an underscore, locate the corresponding tag without the underscore and merge the 
    contents of the underscored object with the contents of the basic tag (which will already _be_ an object from step 1:
    
    ```json
   {
    "birthDate": "1970-03-30",
     "_birthDate": {
       "id": "314159",
       "extension" : [ {
          "url" : "http://example.org/fhir/StructureDefinition/text",
          "valueString" : "Easter 1970"
       }]
     }
   }
   ```
   Step 1:
   ```json
   {
    "birthDate": {"value": "1970-03-30"},
     "_birthDate": {
       "id": {"value": "314159"},
       "extension" : [ {
          "url" : {"value": "http://example.org/fhir/StructureDefinition/text"},
          "valueString" : {"value": "Easter 1970"}
       }]
     }
   }
   ```
    Step 2:
   ```json
   {
    "birthDate": {"value": "1970-03-30", "@type": "xsd:dateTime"},
     "_birthDate": {
       "id": {"value": "314159"},
       "extension" : [ {
          "url" : {"value": "http://example.org/fhir/StructureDefinition/text", "@type":  "xsd:anyURI"},
          "valueString" : {"value": "Easter 1970"}
       }]
     }
   }
   ```
    And finally:
   ```json
   {
    "birthDate": {
      "value": "1970-03-30", 
      "@type": "xsd:dateTime",
       "id": {"value": "314159"},
       "extension" : [ {
          "url" : {"value": "http://example.org/fhir/StructureDefinition/text", "@type":  "xsd:anyURI"},
          "valueString" : {"value": "Easter 1970"}
       }]
     }
   }
   ```  
      

   
5) **Concept References**
    
    FHIR uses the composite [Coding](http://build.fhir.org/datatypes.html#Coding) datatype to reference a concept identifier.
    A key element of the RDF implementation is the notion of concept URI's.  Where _possible_, we need generate a "type arc"
    for a concept identifier that references a URL. Note that there Were more mappings in our original submission, but the
    current two (with an error in LOINC) can be found at 
    https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.r5/src/main/java/org/hl7/fhir/r5/formats/RdfParserBase.java

   
   See: http://tinyurl.com/s6gkyx7 for an example

8) **OWL Ontology Header**

    The OWL Ontology header is often used as a "poor man's" document wrapper in OWL and RDF land.  It asserts provenance
    for the set of triples that occur in the same physical document as the header itself.  The following should be added
    to every JSON resource to generate the header:
    
    R4 JSON
    ```json
      "@included": {
         "@id": "Observation/f001.ttl",
         "@type": "owl:Ontology,"
         "owl:imports": "fhir:fhir.ttl",
         "owl:versionIRI": "Observation/f001.ttl"
      }
    ```
   
   CONTEXT
   ```json
    "owl:versionIRI": {"@type": "@id"},
    "owl:imports": {"@type": "@id"},
   ```
   
   [Ontology Header Example](http://tinyurl.com/sacszom)
   
   
   
----------
Old material

    
   The FHIR R4 RDF specification _adds_ the type field, meaning that it is necessary to add an attribute to the core
   JSON:
   
        `"@id": "<resourceType>/<id>"
   
   
   A FHIR resource references its subject via the `"id"` key, which will form the URI _relative_ to the document base.
   
   _**TODO:**_ We need to establish whether the `"id"` tag is used for anything _but_ identifiers.  If it is, we will
   either a) identify these situations and disable the default processing or b) change `"id"` to `"@id"` in the JSON
   preprocessor.  An example of a) would be:
   
   ```"@context": {
         "id": "@id",
            ...
         "someReference": {
            "id": null
         },
   ```
   {
     "id": "Patient/f001",
     "name": "fred",
     "something": {
        ""
        "id": {"advice" : "Take drugs"}
        
:Patient/f001 fhir:name "fred";
              fhir:something {
                 ""
   JSON: `"id": "<relative or absolute URI>"`
   <br/>RDF: `<subject URI> a <resourceType>`
   
   @context: 
    <br/>&nbsp;&nbsp; &nbsp; &nbsp;`"id" : "@id",`
    
    **[Example](http://tinyurl.com/spex7s8)**
    
    _**Note:**_ https://github.com/fhircat/FHIRCat/issues/2 indicates that we need to escape inner `id`'s -- it isn't obvious
    why this is the case.  Needs further discussion...
    
 
{
   "resourceType": "Patient",
   "id": "Patient/f001"
   "status": "final" .
   "_status": {"id": "y"},
   "state": {"app": 17, "@id": "x"},
   
    "_state": {"id": "x"},
    
    "_state": {"id": "#x"},
 
    "state": {"x": 17, "id": "i"}
  
:s fhir:state :s#x.
:s#x fhir:app 17.
    
http://fhir.org/server/Patient/f001 fhir:status "final".
http://fhir.org/server/Patient/f001# fhir:x 17.

    
inst."x"


"foo2": 
"_foo2": 

:s :foo2  ?v .
:s fhir:extension [...] .


This is the set of transformations that can be done using only a JSON-LD Context, although we
have also recorded transformations that can be accomplished via the [framing API].