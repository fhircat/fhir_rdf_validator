# Proposed FHIR R5 RDF model

See: https://github.com/fhircat/FHIRCat/issues/2 and [FHIRR4.md]() for additional information

This document describes the proposed "tweaks" that are used to convert from 
"vanilla" FHIR JSON into the proposed FHIR RDF format.


## Nomenclature
* **Vanilla JSON (or just "JSON" when the context is obvious)** - FHIR JSON representations in use in the FHIR ecosystem today.
* **R5 JSON** - FHIR JSON that has been modified to include additional elements -- such as the `fhir:nodeRole` item,
explicit list ordering, extensible values, etc. -- which are used in the R4 version of FHIR/RDF.  The R5 version
represents our proposed changes
* **R5 RDF** - FHIR R5 RDF where appropriate


## JSON LD 1.1 Contexts
There are currently two JSON-LD 1.1 context repositories that can be used in the development below, these being:
* https://github.com/fhircat/jsonld_context_files - these files were generated by an extension to the core FHIR build
package and, assuming that this project is successful, will become part of the core FHIR distribution.
* https://github.com/fhircat/fhir_to_jsonld_context -- this is a early converter that takes the JSON representation
of the FHIR ShEx as input and generates the same set of files.  _It is anticipated that this branch will eventually be
retired._

There is also a FHIR context server at https://fhircat.org/fhir/contexts/r5/ that, at the moment, serves an image of the ShEx conversion above.  
As an example, one can fetch the JSON-LD context for the [FHIR Patient resource](http://build.fhir.org/patient.html)
via https://fhircat.org/fhir/contexts/r5/patient.context/jsonld

_Warning:_ These contexts are still in the early stages of development.  These contexts will be in a state of flux for
at least a while yet.


## Transformations

### RDF Namespace Prefixes

   The list below carries  current set of RDF namespaces that are used by at least one FHIR resource.  
   
   ```  
   @context: {
       "fhir": "http://hl7.org/fhir/",
       "owl": "http://www.w3.org/2002/07/owl#",
       "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
       "rdfs": "http://www.w3.org/2000/01/rdf-schema#",
       "xsd": "http://www.w3.org/2001/XMLSchema#",
       "dc": "http://purl.org/dc/elements/1.1/",
       "cs": "http://hl7.org/orim/codesystem/",
       "dc": "http://purl.org/dc/elements/1.1/",
       "dcterms": "http://purl.org/dc/terms/",
       "dt": "http://hl7.org/orim/datatype/",
       "ex": "http://hl7.org/fhir/StructureDefinition/",
       "fhir-vs": "http://hl7.org/fhir/ValueSet/",
       "loinc": "http://loinc.org/rdf#",
       "os": "http://open-services.net/ns/core#",
       "rim": "http://hl7.org/orim/class/",
       "rim": "http://hl7.org/owl/rim/",
       "sct": "http://snomed.info/id/",
       "vs": "http://hl7.org/orim/valueset/",
       "w5": "http://hl7.org/fhir/w5#"
   }
   ```
    
   **TODO:** This list will continue to expand as new code systems and other things are added to FHIR.  We need to
    develop a mechanism ([prefixcommons](https://github.com/prefixcommons)?, CTS2 service?) to maintain them.  For the
    time being, we've added them to our [current context directory](https://github.com/fhircat/jsonld_context_files/tree/master/contextFiles/root.context.jsonld)
    
### The Resource Subject
We need to insert an `@id` into the root JSON object to assign the subject URI of the resource.  The subject URI is
constructed from three components:

1) The resource `id` (e.g. 'pat4')
2) The resource type ('resourceType') (e.g. 'Patient')
3) The server base address - see: http://build.fhir.org/resource.html#id for details.

Note that the `resourceType` must also be edited to assume the "value" form.  This transformation is described in more
detail later in this document.

**JSON:** 
```
  "resourceType": "Patient",
  "id": "pat4",
```

**R5 JSON:**
Add a single identifier node that combines the resource type and the id
```
   "@id": "Patient/pat4",
```

**JSON-LD Context:**

(Optional) add a base, which will be used to interpret all target identifiers.

Notes:
1) If there is no base, this defaults to the location of the "document", which can often be a bit unexpected...
2) `@base` is ignored if it is part of a context fetched as a URL.  It _must_ be an element of the JSON document itself.

```text
  "@context": [{
     ... 
  }, 
  {
    "@base": "http://build.fhir.org/"
  }
```


**[Example](http://tinyurl.com/u7j8aco)**
   
### The Resource Type
The RDF equivalent of the FHIR JSON `"resourceType"` is `rdf:type`.  The snippet:

**R5 JSON-LD Context:**
```
     "resourceType": {
        "@id": "rdf:type",
        "@type": "@id"
    },
```

is a part of every FHIR JSON-LD Resource Context (e.g. [patient.context.jsonld](https://raw.githubusercontent.com/fhircat/jsonld_context_files/master/contextFiles/patient.context.jsonld)
The only bit to take note of is that the `resourceType` should not be transformed to to an embedded value.
 
**[Example](http://tinyurl.com/u7j8aco)**
    
### Tree Root
JSON notation represents a rooted tree. RDF, on the other hand, can represent any graph, meaning that it is necessary
to identify the subject that represents the root of the JSON tree.  We do this by adding the `fhir:nodeRole` element
to the subject of a FHIR resource

**R5 JSON:**
Add the following line to the root document
```
   "fhir:nodeRole" : "fhir:treeRoot",
```

   
**[Example](http://tinyurl.com/u7j8aco)**


### Primitive Values

There will be no changes to primitive values in the FHIR R5 IMPLEMENTATION    

### List Order
 
JSON lists are ordered.  JSON-LD lists are not, so it is necessary to add an ordering index to list elements *when ordering matters*

In R5, we propose that JSON lists will be represented as both unordered and, when order matters, as duplicate, ordered lists.

There are two separate use cases:

#### Lists of primitive values

Example taken from account.profile.json (instance of StructureDefinition)

**JSON**
```json
{
  "resourceType": "StructureDefinition",
  "id": "Account",
  "snapshot" : {
    "element": [
      {
        "id": "Account",
        "alias": [
          "Cost center",
          "Record"
        ]
      }
    ]
  }
}
```

**R5 JSON**
```json
{
  "resourceType": "fhir:StructureDefinition",
  "id": "Account",
  "snapshot": {
    "element": [
      [
        { "id": "Account",
          "alias": [
            [ "Cost center",
              "Record"
            ],
            { "fhir:ordered": [
                "Cost center",
                "Record"
              ]
            }
          ],
          "@id": "#Account"
        }
      ],
      { "fhir:ordered": [
          "#Account"
        ]
      }
    ]
  }
}
```

**R5 Context **
```json
   "fhir:ordered": {"@container": "@list", "@type": "@id"}
```

**R5 RDF**
```text
_:b0 <http://hl7.org/ex/alias> "Cost center" .
_:b0 <http://hl7.org/ex/alias> "Record" .
_:b0 <http://hl7.org/ex/alias> _:b1 .
_:b1 <http://hl7.org/ex/ordered> _:b2 .
_:b2 <http://www.w3.org/1999/02/22-rdf-syntax-ns#first> <https://fhircat.org/jsonld/playground/Cost center> .
_:b2 <http://www.w3.org/1999/02/22-rdf-syntax-ns#rest> _:b3 .
_:b3 <http://www.w3.org/1999/02/22-rdf-syntax-ns#first> <https://fhircat.org/jsonld/playground/Record> .
_:b3 <http://www.w3.org/1999/02/22-rdf-syntax-ns#rest> <http://www.w3.org/1999/02/22-rdf-syntax-ns#nil> .
```

[Example](http://tinyurl.com/yx2zxkmf)


#### Lists of FHIR Objects
We propose taking the same approach that is taken on primitive types, albeit using the identifiers (blank OR URI) of
the list elements

**JSON
```json
  "samples": [ {"entry2": "val2"}, {"entry1": "val1"}, {"entry3": "val3", "id": "e3"}]
```

**R5 JSON
```json
  "samples": [ [{"entry2": "val2", "@id": "_:bn1"}, 
                {"entry1": "val1", "@id": "_:bn3"}, 
                {"entry3": "val3", "id": "e3", "@id": "#e3"} ],
                {"ordered": ["_:bn1", "_:bn2", "#e3"] } ]
```

**R5 RDF
```text
<https://fhircat.org/jsonld/playground/#e3> <http://hl7.org/ex/entry3> "val3" .
<https://fhircat.org/jsonld/playground/#e3> <http://hl7.org/ex/id> "e3" .
_:b0 <http://hl7.org/ex/samples> <https://fhircat.org/jsonld/playground/#e3> .
_:b0 <http://hl7.org/ex/samples> _:b1 .
_:b0 <http://hl7.org/ex/samples> _:b2 .
_:b0 <http://hl7.org/ex/samples> _:b3 .
_:b1 <http://hl7.org/ex/entry2> "val2" .
_:b2 <http://hl7.org/ex/entry1> "val1" .
_:b3 <http://hl7.org/ex/ordered> _:b4 .
_:b4 <http://www.w3.org/1999/02/22-rdf-syntax-ns#first> _:b1 .
_:b4 <http://www.w3.org/1999/02/22-rdf-syntax-ns#rest> _:b5 .
_:b5 <http://www.w3.org/1999/02/22-rdf-syntax-ns#first> _:b2 .
_:b5 <http://www.w3.org/1999/02/22-rdf-syntax-ns#rest> _:b6 .
_:b6 <http://www.w3.org/1999/02/22-rdf-syntax-ns#first> <https://fhircat.org/jsonld/playground/#e3> .
_:b6 <http://www.w3.org/1999/02/22-rdf-syntax-ns#rest> <http://www.w3.org/1999/02/22-rdf-syntax-ns#nil> .
```

http://tinyurl.com/r4t5t3d


## References
FHIR references require two additions:

1) The [Reference](http://build.fhir.org/references.html#Reference) data type includes the `reference` attribute, a "Literal reference, Relative, 
internal or absolute URL".  If this is a relative reference, it is relative to the _parent_ of the resource, not the
resource itself.  As an example, if the resource at the URL `https://fhirserver.org/Observation/o12345` contains a reference
to `"Patient/P1111`, the full URI reference would be `"https://fhirserver.org/Patient/P1111"` instead of 
`"https://fhirserver.org/Observation/Patient/P1111"`, which is what you would get with a normal web page.  As a 
consequence, ".." needs to be prepended to any _relative_ `Reference.reference` entry.

As opposed to R4, which injected a "link" arc between the subject and the object, we want to make the connection as
direct as possible. 

2) When possible, R4 Specification also add a "type arc" in the form ` <http://hl7.org/fhir/Patient/f001> a fhir:Patient .`
Sometimes this is explicitly available 
   

**Sample 1 JSON**
```json
  "resourceType": "Observation",
  "id": "obs1",
  "subject": {
     "reference": "Patient/f001",
     "display": "P. van de Heuvel"
  }
```

**Sample 1 R5 JSON**
Sample 1:
```json
{
  "resourceType": "Observation",
  "id": "obs1",
  "@id": "Observation/obs1",
  "subject": [{"@id": "../Patient/foo1",
            "@type": "fhir:Patient" },
            {"reference": "Patient/f001",
            "display": "P. van de Heuvel"}]
}
```

**Sample 1 RDF**
```text
<http://hl7.org/Patient/foo1> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://hl7.org/fhir/Patient> .
<http://hl7.org/fhir/Observation/obs1> <http://hl7.org/fhir/Observation.subject> <http://hl7.org/Patient/foo1> .
<http://hl7.org/fhir/Observation/obs1> <http://hl7.org/fhir/Observation.subject> _:b0 .
<http://hl7.org/fhir/Observation/obs1> <http://hl7.org/fhir/Resource.id> "obs1" .
<http://hl7.org/fhir/Observation/obs1> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://hl7.org/fhir/Observation> .
_:b0 <http://hl7.org/fhir/Reference.display> "P. van de Heuvel" .
_:b0 <http://hl7.org/fhir/Reference.reference> "Patient/f001" .
```

http://tinyurl.com/sdpmuae

**Sample 2 JSON**
```json
{
  "resourceType": "Observation",
  "id": "bmd",
  "subject": {
    "reference": "http://example.org/nonfhirurl/bmd",
    "type": "Patient"
  }
}
```

**Sample 2 R5 JSON**
```json
{
   "resourceType": "Observation",
  "id": "bmd",
  "@id": "Observation/bmd",
  "subject": [{"@id": "http://example.org/nonfhirurl/bmd",
               "@type": "fhir:Patient" },
              {"reference": "http://example.org/nonfhirurl/bmd",
               "type": "Patient"}]
}
```

**Sample 2 RDF**
```text
<http://example.org/nonfhirurl/bmd> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://hl7.org/fhir/Patient> .
<http://hl7.org/fhir/Observation/bmd> <http://hl7.org/fhir/Observation.subject> <http://example.org/nonfhirurl/bmd> .
<http://hl7.org/fhir/Observation/bmd> <http://hl7.org/fhir/Observation.subject> _:b0 .
<http://hl7.org/fhir/Observation/bmd> <http://hl7.org/fhir/Resource.id> "bmd" .
<http://hl7.org/fhir/Observation/bmd> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://hl7.org/fhir/Observation> .
_:b0 <http://hl7.org/fhir/Reference.reference> "http://example.org/nonfhirurl/bmd" .
_:b0 <http://hl7.org/fhir/Reference.type> "Patient" .
```

http://tinyurl.com/tq45w77

**Sample 3 JSON**
```json
{
  "resourceType": "Observation",
  "id": "bmd",
  "subject": {
    "reference": "http://example.org/nonfhirurl/bmd"
  }
}
```
    
**Sample 3 R5 JSON:**
```json
{
  "resourceType": "Observation",
  "id": "bmd",
  "@id": "Observation/bmd",
  "subject": [{"@id": "http://example.org/nonfhirurl/bmd"},
              {"reference": "http://example.org/nonfhirurl/bmd"}]
}
```

**Sample 3 RDF**
```text
<http://hl7.org/fhir/Observation/bmd> <http://hl7.org/fhir/Observation.subject> <http://example.org/nonfhirurl/bmd> .
<http://hl7.org/fhir/Observation/bmd> <http://hl7.org/fhir/Observation.subject> _:b0 .
<http://hl7.org/fhir/Observation/bmd> <http://hl7.org/fhir/Resource.id> "bmd" .
<http://hl7.org/fhir/Observation/bmd> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://hl7.org/fhir/Observation> .
_:b0 <http://hl7.org/fhir/Reference.reference> "http://example.org/nonfhirurl/bmd" .
```

http://tinyurl.com/sjlz7mr

## RDF Data Types

All non-string values need to have a corresponding RDF datatype inserted.  This requires access to the 
FHIR metamodel, as the JSON itself does not have sufficient typing information.

1) **Case 1:** value has an explicit type - see: http://build.fhir.org/datatypes.html#Period for an example, where both
   the start and end nodes are of the _FHIR_ type `dateTime`. The current R4 type map can be found in 
   [RDFTypeMap.java](https://github.com/HL7/fhir/blob/master/implementations/java/org.hl7.fhir.rdf/src/org/hl7/fhir/rdf/RDFTypeMap.java).
   
2) **Case 2:** variable value type - the datatype is encoded onto the end of the variable name.  This can be identified
   in the FHIR metamodel, and is represented as `<tag>[x]` where `x` is the actual datatype (e.g. `valueBoolean`, 
   `valueDateTime`, etc.) The data type has to be parsed from the key and then mapped as with Case 1 above.
       
## Primitive Type and ID Extensions
    
FHIR primitive types derive from [Element](http://build.fhir.org/types.html#Element), meaning that _any_ data element
can have an `id` and/or `extension`.  The FHIR JSON rendering keeps underlying data "primitive" (i.e. represented as
a value, not a JSON Object), but uses a lexical convention to associate the base element with the additional attributes.
The JSON will prepend an underscore ('_') to the key name with an object that contains the `id` and/or `extension`.

This can be addressed in the context via the following, but we need to consider that it could end up being a very long
list:
```json
{
  "@context": {
     "_(tag)": "(tag)"
  }
}
```

Example:

**Primitive Extension in JSON**
```json
{
    "resourceType": "Patient",
    "id": "somepat",
    "birthDate": "1974-12-25",
    "_birthDate": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/StructureDefinition/patient-birthTime",
            "valueDateTime": "1974-12-25T14:35:45-05:00"
          }
        ]
    }
}
```

**Primitive Extension in R5 JSON**
```json
{
  "@context": {
    "_birthDate": "birthDate"
  },
  "resourceType": "Patient",
  "id": "somepat",
  "@id": "Patient/somepat",
  "birthDate": "1974-12-25",
  "_birthDate": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/patient-birthTime",
        "valueDateTime": "1974-12-25T14:35:45-05:00"
      }
    ]
  }
}
```

**Primitive Extension in RDF**
```text
<http://hl7.org/fhir/Patient/somepat> <http://hl7.org/fhir/Patient.birthDate> "1974-12-25" .
<http://hl7.org/fhir/Patient/somepat> <http://hl7.org/fhir/Patient.birthDate> _:b0 .
<http://hl7.org/fhir/Patient/somepat> <http://hl7.org/fhir/Resource.id> "somepat" .
<http://hl7.org/fhir/Patient/somepat> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://hl7.org/fhir/Patient> .
_:b0 <http://hl7.org/fhir/DomainResource.extension> _:b1 .
_:b1 <http://hl7.org/fhir/Extension.url> "http://hl7.org/fhir/StructureDefinition/patient-birthTime" .
_:b1 <http://hl7.org/fhir/Extension.valueDateTime> "1974-12-25T14:35:45-05:00" .
```
      
http://tinyurl.com/vefuc8x

## Concept References
    
FHIR uses the composite [Coding](http://build.fhir.org/datatypes.html#Coding) datatype to reference a concept identifier.
A key element of the RDF implementation is the notion of concept URI's.  Where _possible_, we need generate a "type arc"
for a concept identifier that references a URL. Note that there Were more mappings in our original submission, but the
current two (with an error in LOINC) can be found at 
https://github.com/hapifhir/org.hl7.fhir.core/blob/master/org.hl7.fhir.r5/src/main/java/org/hl7/fhir/r5/formats/RdfParserBase.java.

**JSON:**
```
{
  "resourceType": "Observation",
  "id": "bmd",
  "code": {
    "coding": [
      {
        "system": "http://loinc.org",
        "code": "24701-5",
        "display": "Femur DXA Bone density"
      }
    ],
    "text": "BMD - Left Femur"
  },
  "bodySite": {
    "coding": [
      {
        "system": "http://snomed.info/sct",
        "code": "71341001:272741003=7771000"
      }
    ],
    "text": "Left Femur"
  }
}
```

**R5 JSON:**
```json
"code": {
    "coding": [
       {
          "system": {
             "value": "http://loinc.org"
          },
          "code": {
             "value": "24701-5"
          },
          "display": {
             "value": "Femur DXA Bone density"
          },
          "index": 0,
          "@type": "loinc:24701-5"
       }
    ],
    "text": {
       "value": "BMD - Left Femur"
    }
 },
 "bodySite": {
    "coding": [
       {
          "system": {
             "value": "http://snomed.info/sct"
          },
          "code": {
             "value": "71341001:272741003=7771000"
          },
          "index": 0,
          "@type": "sct:71341001:272741003=7771000"
       }
    ],
    "text": {
       "value": "Left Femur"
    }
 },
```

   
   [Coding Example](http://tinyurl.com/s6gkyx7 for an example)

## OWL Ontology Header

    The OWL Ontology header is often used as a "poor man's" document wrapper in OWL and RDF land.  It asserts provenance
    for the set of triples that occur in the same physical document as the header itself.  The following should be added
    to every JSON resource to generate the header:
    
    R4 JSON
    ```json
      "@included": {
         "@id": "Observation/f001.ttl",
         "@type": "owl:Ontology,"
         "owl:imports": "fhir:fhir.ttl",
         "owl:versionIRI": "Observation/f001.ttl"
      }
    ```
   
   CONTEXT
   ```json
    "owl:versionIRI": {"@type": "@id"},
    "owl:imports": {"@type": "@id"},
   ```
   
   [Ontology Header Example](http://tinyurl.com/sacszom)
   
   